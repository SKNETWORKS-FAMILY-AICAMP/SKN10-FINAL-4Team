{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ influencer.name }} Chat</title>
    <link rel="stylesheet" href="{% static 'influencers/chat.css' %}">
</head>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatForm = document.getElementById('chat-form');
        const chatLog = document.getElementById('chat-log');
        if (chatForm) {
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const input = document.getElementById('chat-input');
                const message = input.value;
                if (!message.trim()) return;
                // Append user message
                chatLog.innerHTML += `
                    <div class="chat-bubble user-bubble">
                        <strong>나:</strong> ${message}
                    </div>
                `;
                fetch("{% url 'send_message' influencer.id %}", {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: "message=" + encodeURIComponent(message)
                })
                .then(response => response.json())
                .then(data => {
                    // Append OpenAI answer
                    chatLog.innerHTML += `
                        <div class="chat-bubble ai-bubble">
                            <strong>{{ influencer.name }}:</strong> ${data.answer}
                        </div>
                    `;
                    // Play audio if available
                    if (data.audio_url) {
                        const audio = new Audio(data.audio_url);
                        audio.play();
                    }
                    input.value = '';
                    chatLog.scrollTop = chatLog.scrollHeight;
                });
            });
        }
    });
    </script>
<body>
    <a href="{% url 'landingpage' %}" class="back-btn">뒤로가기</a>
    <div class="chat-container">
        <div class="profile-section">
            <img src="{% if influencer.image %}{{ influencer.image.url }}{% else %}{% static 'home/gamst.png' %}{% endif %}" class="profile-img" alt="{{ influencer.name }}">
            <div class="profile-name">{{ influencer.name }}</div>
            <div class="profile-desc">{{ influencer.description }}</div>
            <div class="profile-author">By {{ influencer.name }}</div>
        </div>
        <div class="chat-bubble">
            <div class="chat-meta">
                <img src="{% if influencer.image %}{{ influencer.image.url }}{% else %}{% static 'home/gamst.png' %}{% endif %}" style="width: 28px; height: 28px; border-radius: 50%; margin-right: 8px;">
                <span class="profile-name" style="font-size:1rem; font-weight:600; margin:0;">{{ influencer.name }}</span>
                <span style="font-size:0.95rem; color:#b0b0b0;">c.ai</span>
                <span style="font-size:1.1rem; color:#3fa7ff;">&#9654;</span>
            </div>
            <div>
                <em>its morning, you are on your way to school. When you arrive to the gates you see Momoka who looks at you with a cold strict look. She walks to you while swaying her hips to tease you.<br>
                You are almost late, again. Care to explain ? she cross her arms to show off her "pride" to tease you even more.</em>
            </div>
        </div>
        <div class="chat-footer">
            This is A.I. and not a real person. Treat everything it says as fiction
        </div>
    </div>
    <div id="chat-log" class="chat-log"></div>
    <form class="chat-input-section" id="chat-form">
        <div class="chat-input-box">
            <input class="chat-input" id="chat-input" type="text" placeholder="Message {{ influencer.name }}..." autocomplete="off">
            <button class="chat-send-btn" type="submit">&#9658;</button>
        </div>
    </form>
    <div id="chat-result" style="color: #fff; text-align: center; margin-top: 20px;"></div>
</body>
</html>
